<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS Player - Stream Capture</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .player-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .player-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        #video-container {
            position: relative;
            width: 100%;
            background: #000;
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .video-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 10;
        }
        
        .controls-panel {
            padding: 20px;
            background: #f8f9fa;
            border-top: 3px solid #667eea;
        }
        
        .stats-panel {
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .quality-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-live { background: #28a745; animation: pulse 2s infinite; }
        .status-loading { background: #ffc107; }
        .status-error { background: #dc3545; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .btn-control {
            min-width: 120px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <!-- Header -->
        <div class="player-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-play-circle"></i>
                        <span id="streamTitle">HLS Player</span>
                    </h2>
                    <small id="streamUrl" class="opacity-75">Carregando...</small>
                </div>
                <div>
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">Iniciando...</span>
                </div>
            </div>
        </div>

        <!-- Video Player -->
        <div id="video-container">
            <video id="video" controls crossorigin="anonymous"></video>
            <div class="video-overlay" id="videoOverlay">
                <div class="spinner-border text-light mb-3" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p>Carregando stream...</p>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-panel">
            <div class="row">
                <div class="col-md-8">
                    <h5><i class="fas fa-sliders-h"></i> Controles</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-success btn-control" id="playBtn">
                            <i class="fas fa-play"></i> Play
                        </button>
                        <button class="btn btn-warning btn-control" id="pauseBtn">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="btn btn-info btn-control" id="reloadBtn">
                            <i class="fas fa-sync"></i> Reload
                        </button>
                        <button class="btn btn-secondary btn-control" id="muteBtn">
                            <i class="fas fa-volume-up"></i> Mute
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <label><i class="fas fa-volume-up"></i> Volume:</label>
                        <input type="range" class="form-range" id="volumeSlider" 
                               min="0" max="100" value="80">
                    </div>
                    
                    <div class="mt-3">
                        <label><i class="fas fa-tachometer-alt"></i> Qualidade:</label>
                        <select class="form-select" id="qualitySelector">
                            <option value="-1">Auto (melhor dispon√≠vel)</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h5><i class="fas fa-chart-line"></i> Estat√≠sticas</h5>
                    <div class="stats-panel">
                        <div class="stat-item">
                            <strong>Status:</strong>
                            <span id="statStatus">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>Bitrate:</strong>
                            <span id="statBitrate">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>FPS:</strong>
                            <span id="statFps">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>Buffer:</strong>
                            <span id="statBuffer">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>Dropped:</strong>
                            <span id="statDropped">0</span>
                        </div>
                        <div class="stat-item">
                            <strong>Lat√™ncia:</strong>
                            <span id="statLatency">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Obter par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const siteId = urlParams.get('site') || 'freeshot_dazn';
        const streamUrl = urlParams.get('url') || `/hls/${siteId}/stream.m3u8`;
        
        // Elementos DOM
        const video = document.getElementById('video');
        const videoOverlay = document.getElementById('videoOverlay');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const streamTitle = document.getElementById('streamTitle');
        const streamUrlEl = document.getElementById('streamUrl');
        const qualitySelector = document.getElementById('qualitySelector');
        
        // Configurar t√≠tulo
        streamTitle.textContent = siteId.replace(/_/g, ' ').toUpperCase();
        streamUrlEl.textContent = streamUrl;
        
        let hls = null;
        let statsInterval = null;
        
        // Inicializar HLS.js
        function initPlayer() {
            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 600,
                    maxBufferSize: 60 * 1000 * 1000,
                    maxBufferHole: 0.5,
                    highBufferWatchdogPeriod: 2,
                    nudgeOffset: 0.1,
                    nudgeMaxRetry: 3,
                    maxFragLookUpTolerance: 0.25,
                    liveSyncDurationCount: 3,
                    liveMaxLatencyDurationCount: Infinity,
                    liveDurationInfinity: false,
                    liveBackBufferLength: Infinity,
                    maxLiveSyncPlaybackRate: 1.5
                });
                
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                
                // Event Listeners HLS
                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    console.log('‚úÖ Manifest carregado:', data);
                    hideOverlay();
                    updateStatus('live', 'Stream Online');
                    
                    // Preencher seletor de qualidade
                    populateQualitySelector(data.levels);
                    
                    // Auto-play
                    video.play().catch(e => {
                        console.warn('Auto-play bloqueado:', e);
                        updateStatus('loading', 'Clique em Play para iniciar');
                    });
                });
                
                hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                    console.log('üé¨ Qualidade alterada:', data.level);
                    updateQualityBadge(data.level);
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('‚ùå Erro HLS:', data);
                    
                    if (data.fatal) {
                        updateStatus('error', 'Erro Fatal: ' + data.type);
                        
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.error('Network error, tentando recuperar...');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.error('Media error, tentando recuperar...');
                                hls.recoverMediaError();
                                break;
                            default:
                                console.error('Erro irrecuper√°vel');
                                showOverlay('Erro ao carregar stream. Recarregue a p√°gina.');
                                break;
                        }
                    }
                });
                
                hls.on(Hls.Events.FRAG_LOADED, function(event, data) {
                    updateStats();
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari nativo
                video.src = streamUrl;
                video.addEventListener('loadedmetadata', function() {
                    hideOverlay();
                    updateStatus('live', 'Stream Online (Native)');
                    video.play();
                });
            } else {
                showOverlay('‚ùå Seu navegador n√£o suporta HLS');
                updateStatus('error', 'Navegador n√£o suportado');
            }
        }
        
        // Popular seletor de qualidade
        function populateQualitySelector(levels) {
            qualitySelector.innerHTML = '<option value="-1">Auto (melhor dispon√≠vel)</option>';
            
            levels.forEach((level, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${level.height}p (${Math.round(level.bitrate / 1000)} kbps)`;
                qualitySelector.appendChild(option);
            });
        }
        
        // Atualizar badge de qualidade
        function updateQualityBadge(levelIndex) {
            if (hls && hls.levels[levelIndex]) {
                const level = hls.levels[levelIndex];
                document.getElementById('statBitrate').innerHTML = 
                    `<span class="quality-badge bg-success">${level.height}p</span> ${Math.round(level.bitrate / 1000)} kbps`;
            }
        }
        
        // Atualizar estat√≠sticas
        function updateStats() {
            if (!hls) return;
            
            const stats = hls.stats;
            const video = document.getElementById('video');
            
            // Bitrate
            if (hls.currentLevel >= 0) {
                const level = hls.levels[hls.currentLevel];
                document.getElementById('statBitrate').innerHTML = 
                    `${Math.round(level.bitrate / 1000)} kbps`;
            }
            
            // Buffer
            const buffered = video.buffered;
            if (buffered.length > 0) {
                const bufferEnd = buffered.end(buffered.length - 1);
                const bufferLength = bufferEnd - video.currentTime;
                document.getElementById('statBuffer').textContent = 
                    `${bufferLength.toFixed(1)}s`;
            }
            
            // Dropped frames
            if (video.getVideoPlaybackQuality) {
                const quality = video.getVideoPlaybackQuality();
                document.getElementById('statDropped').textContent = 
                    quality.droppedVideoFrames;
            }
            
            // FPS (estimado)
            if (stats.total && stats.total.framedrop !== undefined) {
                document.getElementById('statFps').textContent = 
                    Math.round(video.mozDecodedFrames || 30) + ' fps';
            }
            
            // Lat√™ncia
            if (hls.latency) {
                document.getElementById('statLatency').textContent = 
                    `${(hls.latency).toFixed(2)}s`;
            }
        }
        
        // Atualizar status
        function updateStatus(type, message) {
            statusIndicator.className = 'status-indicator status-' + type;
            statusText.textContent = message;
            document.getElementById('statStatus').innerHTML = 
                `<span class="badge bg-${type === 'live' ? 'success' : type === 'error' ? 'danger' : 'warning'}">${message}</span>`;
        }
        
        // Overlay
        function hideOverlay() {
            videoOverlay.style.display = 'none';
        }
        
        function showOverlay(message) {
            videoOverlay.innerHTML = `<p>${message}</p>`;
            videoOverlay.style.display = 'block';
        }
        
        // Event Listeners - Controles
        document.getElementById('playBtn').addEventListener('click', () => {
            video.play();
            updateStatus('live', 'Reproduzindo');
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            video.pause();
            updateStatus('loading', 'Pausado');
        });
        
        document.getElementById('reloadBtn').addEventListener('click', () => {
            showOverlay('Recarregando stream...');
            if (hls) {
                hls.destroy();
            }
            initPlayer();
        });
        
        document.getElementById('muteBtn').addEventListener('click', (e) => {
            video.muted = !video.muted;
            e.target.innerHTML = video.muted ? 
                '<i class="fas fa-volume-mute"></i> Unmute' : 
                '<i class="fas fa-volume-up"></i> Mute';
        });
        
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            video.volume = e.target.value / 100;
        });
        
        qualitySelector.addEventListener('change', (e) => {
            if (hls) {
                hls.currentLevel = parseInt(e.target.value);
            }
        });
        
        // Iniciar player
        initPlayer();
        
        // Atualizar stats a cada 1s
        statsInterval = setInterval(updateStats, 1000);
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (hls) {
                hls.destroy();
            }
            if (statsInterval) {
                clearInterval(statsInterval);
            }
        });
    </script>
</body>
</html>
